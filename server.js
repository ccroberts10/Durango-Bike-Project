const express = require('express');
const twilio = require('twilio');
const { Client, Environment } = require('square');
const { randomUUID } = require('crypto');
const path = require('path');

const app = express();
app.use(express.json());
app.use(express.static(__dirname));

// CORS â€” needed for Squarespace and Square payments
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Headers', 'Content-Type');
  res.header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
  // Remove any CSP headers that might block Square.js execution
  res.removeHeader('Content-Security-Policy');
  res.removeHeader('X-Content-Security-Policy');
  res.removeHeader('X-WebKit-CSP');
  if (req.method === 'OPTIONS') return res.sendStatus(200);
  next();
});

// Health check â€” Railway uses this to verify the server is running
app.get('/health', (req, res) => res.status(200).send('OK'));

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TWILIO_ACCOUNT_SID  = process.env.TWILIO_ACCOUNT_SID  || 'ACxxxxxxxxx';
const TWILIO_AUTH_TOKEN   = process.env.TWILIO_AUTH_TOKEN   || 'your_token';
const TWILIO_FROM_NUMBER  = process.env.TWILIO_FROM_NUMBER  || '+1XXXXXXXXXX';
const SHOP_PHONE          = '+19709023252';

const SQUARE_ACCESS_TOKEN = process.env.SQUARE_ACCESS_TOKEN || 'EAAAl0nyXfsbWNt6kfDb_1rNOSgkHF5sdPzK9i3c6XdFbPnr7AM930gq8364xKZu';
const SQUARE_LOCATION_ID  = process.env.SQUARE_LOCATION_ID  || 'L9CZZEX9TKZS9';
const SQUARE_ENV          = process.env.SQUARE_ENV          || 'production'; // change to 'production' when live
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const twilioClient = twilio(TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN);

const squareClient = new Client({
  accessToken: SQUARE_ACCESS_TOKEN,
  environment: SQUARE_ENV === 'production' ? Environment.Production : Environment.Sandbox,
});


// Apple Pay domain verification
app.get('/.well-known/apple-developer-merchantid-domain-association', (req, res) => {
  res.setHeader('Content-Type', 'text/plain');
  res.send('7B227073704964223A2242383642463746383933373735353242343346373441324434304635313141343141334233383342463146384542463741443644463733303342413638363031222C2276657273696F6E223A312C22637265617465644F6E223A313731353230333837363638312C227369676E6174757265223A2233303830303630393261383634383836663730643031303730326130383033303830303230313031333130643330306230363039363038363438303136353033303430323031333038303036303932613836343838366637306430313037303130303030613038303330383230336533333038323033383861303033303230313032303230383136363334633862306533303537313733303061303630383261383634386365336430343033303233303761333132653330326330363033353530343033306332353431373037303663363532303431373037303663363936333631373436393666366532303439366537343635363737323631373436393666366532303433343132303264323034373333333132363330323430363033353530343062306331643431373037303663363532303433363537323734363936363639363336313734363936663665323034313735373436383666373236393734373933313133333031313036303335353034306130633061343137303730366336353230343936653633326533313062333030393036303335353034303631333032353535333330316531373064333233343330333433323339333133373334333733323337356131373064333233393330333433323338333133373334333733323336356133303566333132353330323330363033353530343033306331633635363336333264373336343661373032643632373236663662363537323264373336393637366535663535343333343264353035323466343433313134333031323036303335353034306230633062363934663533323035333739373337343635366437333331313333303131303630333535303430613063306134313730373036633635323034393665363332653331306233303039303630333535303430363133303235353533333035393330313330363037326138363438636533643032303130363038326138363438636533643033303130373033343230303034633231353737363536333634333733343338333733363337363336323632363133363333363336363631363533343631333636333334333436313631333633343631333333373636333436353636333436333333333636363336363133363336333836333634333633363636333333353332333636313336333133333336363336333634333733333633333633323631333633353336363636363631333336333336333733363333363336363333363633363333333733363333363333363333333733363636333636363333363336333631333636363336363433363636333633353334363333363337363633363631333736363336333336363333363636333334333733363333333633363633333336363336333733363333363333363334333333363636333636363333363336363336363336363333363333363633363633333633363336363333363633363636333636363333363636333633333636333366363333363333363333363333333636333633363336363333333636333636333636363333363636333636333636333636333636363336333336363333363333333636333636333633363633363636363633333636363333363633363633333336363336333636333336363336366133303832303231313330333036333036303335353164313330313031666630343032333030303330316630363033353531643233303431383330313638303134323366323439633434663933653465663237653663346636323836633366613262626664326534363233303435303630383262303630313035303530373031303130343339333033373330333530363038326230363031303530353037333030313836323936383734373437303361326632663666363337333730326536313730373036633635326536333666366432663666363337333730333033343264363137303730366336353631363936333631333333303332333038323031316430363033353531643230303438323031313433303832303131303330383230313063303630393261383634383836663736333634303530313330383166653330383163333036303832623036303130353035303730323032333038316236306338316236333537333636633639363136653633363532303666366532303734363836393733323036333635373237343639363636393633363137343635323036323739323036313665373932303730363137323734373932303631373337333735366436353733323036313633363336353730373436313665363332303666363632303734363836353230373436383635366532303631373037303663363936333631363236633635323037333734363136653634363137323634323037343635373236643733323036313665363432303633366636653634363937343639366636653733323036663636323037353733363532633230363336353732373436393636363936333631373436353230373036663663363936333739323036313665363432303633363537323734363936363639363336313734363936663665323037303732363136333734363936333635323037333734363136373635366436353665373437333265333033363036303832623036303130353035303730323031313632613638373437343730336132663266373737373737326536313730373036633635326536333666366432663633363537323734363936363639363336313734363536313735373436383666373236393734373932663330333430363033353531643166303432643330326233303239363130333237363130323538363233333638373437343730336132663266363337323663326536313730373036633635326536333666366432663631373037303663363536313639363336313333326536333732366333303164303630333535316430653034313630343134333135353335336233363631356435303464363131333335363333313335333633333333333333323333333433353333333633363333333333303330306530363033353531643066303130316666303430343033303230373830333030663036303932613836343838366637363336343036316430343032303530303330306130363038326138363438636533643034303330323033343930303330343630323231303036663636363533393336333036333636333633363335363633383334363336363333333336333336363333363363363633363333333332333336363330363633363636333636363433363665333333333334333536363630333233313330333133363336333933333333363233313333333333333332333133333333363633373333333733363333363333313333333333333330363633363336363633363333363336333636333336363336333336333333366533333336333636363333363336363336333636363333363636363333363636363333363636363333363666333036333332363333333333333633333033363633363633363336363633363636333636363333363636333336363333363336366333333636363333366333333636666633333634363333333636363333363633363336363333363636333363333366333636363336333336363333363633363633363336333336363633363633363366363336363336333636363336363336363366333636333336333636363636363333363633363333363633363633363336633337333636363333363333363336363336363333333633363636333636363333363636363333363666363336363336333636363336363336363366363636333336333636363636363333363633363333363633363633333636333636333633363633363636363633333636363333363633363633333336363336333636333336363336366333363636333336363633333336363633363336363336363636363333363636363636363633363633363336363636333336363333363633363333363636333636366133363636333336363636333036333333333336363633336633363633363533363636333633363633363636363366363336363336333636363336363336363366363636333336333636363636363333363633363333363633363633333636333636333633363633363636363633333636363333363633363633333336363336333636333336363336366333363636333336363633333336363633363336363336363636363333363636363636363633363633363336363636333336363333363633363333363636333636366133303030303030303030303030303030227D');
});


// â”€â”€ SOLD OUT LIST â€” file-backed persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fs = require('fs');
const SOLDOUT_FILE = path.join(__dirname, 'soldout.json');

function loadSoldOut() {
  try {
    if (fs.existsSync(SOLDOUT_FILE)) {
      const data = JSON.parse(fs.readFileSync(SOLDOUT_FILE, 'utf8'));
      return new Set(data);
    }
  } catch(e) { console.error('Could not load soldout.json:', e.message); }
  return new Set();
}

function saveSoldOut() {
  try {
    fs.writeFileSync(SOLDOUT_FILE, JSON.stringify([...soldOutItems]), 'utf8');
  } catch(e) { console.error('Could not save soldout.json:', e.message); }
}

let soldOutItems = loadSoldOut();
console.log(`ðŸ“‹ Loaded ${soldOutItems.size} sold-out items from disk`);

const STAFF_PIN = process.env.STAFF_PIN || '1234'; // change this in Railway vars!

app.get('/api/soldout', (req, res) => {
  res.json({ soldOut: [...soldOutItems] });
});

app.post('/api/soldout', (req, res) => {
  const { pin, item, available } = req.body;
  if (pin !== STAFF_PIN) return res.status(401).json({ error: 'Wrong PIN' });
  if (available) {
    soldOutItems.delete(item);
  } else {
    soldOutItems.add(item);
  }
  saveSoldOut();
  console.log(`ðŸ“‹ Stock update: "${item}" â†’ ${available ? 'IN STOCK' : 'SOLD OUT'}`);
  res.json({ success: true, soldOut: [...soldOutItems] });
});


app.post('/api/soldout/verify', (req, res) => {
  const { pin } = req.body;
  if (pin === STAFF_PIN) { res.json({ ok: true }); }
  else { res.status(401).json({ error: 'Wrong PIN' }); }
});

app.get('/admin', (req, res) => {
  res.sendFile(path.join(__dirname, 'admin.html'));
});

// â”€â”€ PAYMENT + ORDER ENDPOINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.post('/place-order', async (req, res) => {
  const { sourceId, customerName, cart, totalCents } = req.body;

  if (!sourceId || !customerName || !cart || !totalCents) {
    return res.status(400).json({ error: 'Missing required fields' });
  }

  // 1. Charge the card via Square
  let payment;
  try {
    const response = await squareClient.paymentsApi.createPayment({
      sourceId,
      idempotencyKey: randomUUID(),
      amountMoney: {
        amount: BigInt(totalCents),
        currency: 'USD',
      },
      locationId: SQUARE_LOCATION_ID,
      note: `DBP Online Order â€” ${customerName}`,
      buyerEmailAddress: req.body.email || undefined,
    });
    payment = response.result.payment;
  } catch (err) {
    console.error('Square payment error:', JSON.stringify(err, null, 2));
    const msg = err?.errors?.[0]?.detail || 'Payment failed';
    return res.status(402).json({ error: msg });
  }

  // 2. Send text to shop iPhone
  const orderLines = cart.map(i => {
    const mods = i.modsDesc ? `\n      â†’ ${i.modsDesc}` : '';
    return `  â€¢ ${i.name} x${i.qty} = $${(i.price * i.qty).toFixed(2)}${mods}`;
  }).join('\n');
  const subtotal = cart.reduce((s,i) => s + i.price * i.qty, 0);
  const tax = subtotal * 0.094;
  const grandTotal = (totalCents / 100).toFixed(2);
  const smsBody =
    `ðŸš²â˜• NEW ORDER â€” PAID\n` +
    `Name: ${customerName}\n\n` +
    `${orderLines}\n\n` +
    `Subtotal: $${subtotal.toFixed(2)}\n` +
    `Tax (9.4%): $${tax.toFixed(2)}\n` +
    `TOTAL: $${grandTotal} âœ… Card charged\n` +
    `Square ID: ${payment.id.slice(-8)}\n` +
    `Time: ${new Date().toLocaleTimeString()}`;

  try {
    await twilioClient.messages.create({
      body: smsBody,
      from: TWILIO_FROM_NUMBER,
      to: SHOP_PHONE,
    });
  } catch (smsErr) {
    // Payment succeeded â€” don't fail the request just because SMS errored
    console.error('Twilio SMS error:', smsErr.message);
  }

  console.log(`âœ… Order from ${customerName} â€” $${total} charged, SMS sent`);
  res.json({ success: true, paymentId: payment.id });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, '0.0.0.0', () => {
  console.log(`\nðŸš²â˜• DBP Order Server on http://0.0.0.0:${PORT}`);
  console.log(`   Square env: ${SQUARE_ENV}`);
  console.log(`   SMS â†’ ${SHOP_PHONE}\n`);
});
